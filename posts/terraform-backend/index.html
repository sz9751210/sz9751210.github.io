<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 | 艾倫的程式之旅</title>
<meta name=keywords content="terraform backend"><meta name=description content="terraform backend"><meta name=author content="Alan"><link rel=canonical href=https://sz9751210.github.io/posts/terraform-backend/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=icon type=image/png sizes=32x32 href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=apple-touch-icon href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=mask-icon href=https://sz9751210.github.io/assets/profile/avatar.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-4RLTP9J7DY"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4RLTP9J7DY",{anonymize_ip:!1})}</script><meta property="og:title" content="如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔"><meta property="og:description" content="terraform backend"><meta property="og:type" content="article"><meta property="og:url" content="https://sz9751210.github.io/posts/terraform-backend/"><meta property="og:image" content="https://sz9751210.github.io/assets/terraform-backend/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-28T17:10:00+08:00"><meta property="article:modified_time" content="2023-10-28T17:45:32+08:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sz9751210.github.io/assets/terraform-backend/cover.png"><meta name=twitter:title content="如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔"><meta name=twitter:description content="terraform backend"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sz9751210.github.io/posts/"},{"@type":"ListItem","position":2,"name":"如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔","item":"https://sz9751210.github.io/posts/terraform-backend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔","name":"如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔","description":"terraform backend","keywords":["terraform backend"],"articleBody":"👨‍💻簡介 terraform在每次執行terraform plan或terraform apply時，是如何知道應該要管理哪些資源？\n其實就是透過在每次執行terraform時，將建立或要變更的資源都記錄在terraform.state這份狀態檔，預設檔案使用JSON格式。\n假設建立一個google cloud storage的resource，tf設定檔如下：\nresource \"google_storage_bucket\" \"bucket\" { name = \"terraform-alan-test-bucket\" location = \"ASIA-EAST1\" storage_class = \"STANDARD\" public_access_prevention = \"enforced\" force_destroy = true uniform_bucket_level_access = true } 建立後的terraform.tfstate的一小部分如下：\n{ \"version\": 4, \"terraform_version\": \"1.5.7\", \"serial\": 3, \"lineage\": \"abda0fda-b807-b8b3-0a36-8b0c2f92e3f5\", \"outputs\": {}, \"resources\": [ { \"module\": \"module.base-bucket\", \"mode\": \"managed\", \"type\": \"google_storage_bucket\", \"name\": \"bucket\", \"provider\": \"module.base-bucket.provider[\\\"registry.terraform.io/hashicorp/google\\\"]\", \"instances\": [ { \"schema_version\": 1, \"attributes\": { \"autoclass\": [], \"cors\": [], \"custom_placement_config\": [], \"default_event_based_hold\": false, \"effective_labels\": {}, \"encryption\": [], \"force_destroy\": true, \"id\": \"terraform-alan-test-bucket\", \"labels\": null, \"lifecycle_rule\": [], \"location\": \"ASIA-EAST1\", \"logging\": [], \"name\": \"terraform-alan-test-bucket\", } } ] } ] } 可以看到id的屬性，當每次執行plan或是apply時，terraform就是拿這個屬性從本地terraform設定檔與雲上資源做比對。\n如果你的terraform用在個人專案，則將狀態檔存在本機即可；不過如果是一個團隊要使用terraform，則可能會遇到幾個問題：\n狀態檔需要共用：需要確保團隊成員都能正常存取相同的terraform狀態檔。 鎖定狀態檔：需要確保團隊成員使用terraform進行操作時，只有一人能對狀態檔做修改，否則可能會因為多個terraform進程對狀態檔做併發更新，導致資料丟失或是狀態檔損壞。 要解決上述問題，常見的做法是將狀態檔進行版本控制(git)，但因為某些原因，將狀態檔進行版控並不是一個好想法。有底下幾個原因：\n手動操作錯誤：有時候可能在操作terraform時，忘記拉取最新狀態檔，或是在執行完terraform後，忘記將狀態檔更新到版控。可能團隊成員使用到舊的狀態檔導致資源回滾。 鎖定問題：多數的版本控制系統沒提供任何形式的鎖定，防止兩個團隊成員同時對同一份狀態檔執行操作。 加密：terraform狀態檔的資料預設都是以明文形式儲存。但某些資源需要儲存敏感資料，像是資料庫創建時需要建立初始化使用者以及密碼，這些資料不應該以明文的形式儲存在版本控制。 因為以上原因，terraform官方推出 remote backend的支援，可以將狀態檔儲存在所使用的雲平台，而不是使用版本控制，而remote backend解決了剛才列出的三個問題：\n手動操作錯誤：terraform每次運行時會自動從 remote backend 載入狀態檔，並且每次運行後都會自動將狀態檔儲存在 remote backend，解決了手動操作錯誤。 鎖定問題：大多數 remote backend 都支援鎖定。運行terraform時會自動將檔案進行上鎖，確保只會有一人進行操作。 加密：大多數 remote backend 都支援狀態檔的傳輸中加密和靜態加密。 使用gcp平台推薦使用 google cloud storage，整理的原因如下：\n這是託管服務，不需部署和管理額外基礎設施即可使用。 gcs旨在實現99.99%的持久性和年度耐用性。 数据可用性和耐用性 | Cloud Storage | Google Cloud\ngcs支援加密，預設使用server side encrypt，另外也可使用ckms服務 数据加密选项 | Cloud Storage | Google Cloud\n支援版本控制 使用对象版本控制 | Cloud Storage | Google Cloud\n費用便宜，使用免費額度即可滿足需求。 价格 | Cloud Storage | Google Cloud\nGCP GCS作為terraform remote backend 要使用 Google cloud stroage作為 terraform remote backend，首先是先建立 gcs bucket。 在新資料夾中建立一個provider.tf檔案\nterraform { required_providers { google = { source = \"hashicorp/google\" version = \"\u003e=4.0\" } } } provider \"google\" { region =\"asia-east1\" } 接著再建立一個名為bucket.tf檔案，使用 google_storage_bucket resource 建立 gcs bucket。\nresource \"google_storage_bucket\" \"bucket\" { name = \"terraform-alan-test-bucket\" location = \"ASIA-EAST1\" storage_class = \"STANDARD\" public_access_prevention = \"enforced\" force_destroy = false uniform_bucket_level_access = true } 參數說明如下：\nname：定義 gcs bucket 名稱 location：指定 bucket 儲存位置 storage_class：指定 bucket 儲存類型 public_access_prevention：設定公開存取防止策略，enforce表示不允許公開訪問 force_destroy：設定是否可強制刪除 uniform_bucket_level_access：設定是否啟用統一訪問控制 當執行完terraform init以及 terraform apply部署完後，就會看到gcs已經建立完成。但目前狀態檔還是儲存在本地。要將狀態檔儲存到 gcs bucket，需要再額外設定 remote backend，語法如下：\nterraform { backend \"\" { [CONFIG...] } } 其中 BACKEND_NAME是要使用的資源，CONFIG是對這個後端的參數設定。以下是 gcs bucket的後端設定：\nterraform { backend \"gcs\" { bucket = \"terraform-alan-test-bucket\" prefix = \"bucket-state\" } } 參數說明如下：\nbucket：要使用的bucket name，這邊填入剛剛建立的 bucket prefix：定義狀態檔的路徑和名稱，以上述為例，狀態檔會被存放在 bucket-state資料夾 要將狀態檔儲存到 gcs ，只需要重新執行 terraform init 指令。該指令不僅可以下載 provider code，還可以設定 terraform backend。此外，init的指令是冪等的，多次執行可以確保每次都是預期的行為。\n\u003e terraform init Initializing the backend... Do you want to copy existing state to the new backend? Pre-existing state was found while migrating the previous \"local\" backend to the newly configured \"gcs\" backend. No existing state was found in the newly configured \"gcs\" backend. Do you want to copy this state to the new \"gcs\" backend? Enter \"yes\" to copy and \"no\" to start with an empty state. Enter a value: 執行後terraform會自動檢查本地已有的狀態檔，並跳出提示說要將狀態檔複製到 gcs backend。如果輸入 yes，則會看到以下內容：\nSuccessfully configured the backend \"gcs\"! Terraform will automatically use this backend unless the backend configuration changes. Initializing modules... Initializing provider plugins... - Reusing previous version of hashicorp/google from the dependency lock file - Using previously-installed hashicorp/google v5.3.0 Terraform has been successfully initialized! 執行完畢後可以到 gcs查看狀態檔是否已經儲存上去。\n如果之後有資源使用一樣的backend，terraform執行時就會自動從這個 gcs拉取最新的狀態，並且執行後會自動將最新狀態推送到這個 gcs。\n當有兩人同時執行時，則第二個人會出現以下訊息：\n\u003e terraform plan Acquiring state lock. This may take a few moments... ╷ │ Error: Error acquiring the state lock │ │ Error message: writing │ \"gs://terraform-alan-test-bucket/bucket-state/default.tflock\" failed: │ googleapi: Error 412: At least one of the pre-conditions you specified did not │ hold., conditionNotMet │ Lock Info: │ ID: 1698225515771180 │ Path: gs://terraform-alan-test-bucket/bucket-state/default.tflock │ Operation: OperationTypeApply │ Who: alan_wang │ Version: 1.5.7 │ Created: 2023-10-25 09:18:35.490893 +0000 UTC │ Info: │ │ │ Terraform acquires a state lock to protect the state from being written │ by multiple users at the same time. Please resolve the issue above and try │ again. For most commands, you can disable locking with the \"-lock=false\" │ flag, but this is not recommended. 這也確保了執行只會有一人，其他人要操作都會被擋下來。\nAWS S3作為terraform remote backend 依照慣例先來個 provider.tf起手式\nterraform { required_providers { aws = { source = \"hashicorp/aws\" version = \"5.22.0\" } } } provider \"aws\" { alias = \"ap-east-1\" region = \"ap-east-1\" } 接著建立一個名為bucket.tf檔案\nresource \"aws_s3_bucket\" \"terraform_state\" { bucket = \"terraform-alan-test-bucket\" provider = aws.ap-east-1 force_destroy = false # Prevent accidental deletion of this S3 bucket lifecycle { prevent_destroy = true } } 參數說明如下：\nbucket：定義 s3 bucket 名稱 provider：指定 bucket 儲存位置 force_destroy：設定是否可強制刪除 prevent_destroy：任何嘗試刪除該資源的操作都將導致terraform退出並顯示錯誤。 接下來要替s3增加一些額外的保護\n首先新增版本控制，使用aws_s3_bucket_versioning resource開啟版本控制，確保每次更新都會創建新版。當出現問題時也能恢復成舊版：\nresource \"aws_s3_bucket_versioning\" \"enabled\" { bucket = aws_s3_bucket.terraform_state.id versioning_configuration { status = \"Enabled\" } } 參數說明如下：\nbucket：要啟用版本控制的 S3 bucket 的 ID versioning_configuration： status：可用選項為Enabled、Disabled與Suspended，設為 “Enabled” 表示啟用版本控制 接著開啟加密設定，使用 aws_s3_bucket_server_side_encryption_configuration，開啟後寫入到這個 S3 的所有資料都會啟用 server 端的加密。確保狀態檔以及任何存在 S3 的敏感資料都在硬碟上加密：\nresource \"aws_s3_bucket_server_side_encryption_configuration\" \"server_side_encryption\" { bucket = aws_s3_bucket.terraform_state.id rule { apply_server_side_encryption_by_default { sse_algorithm = \"AES256\" } } } 參數說明如下：\nbucket：要啟用版本控制的 S3 bucket 的 ID apply_server_side_encryption_by_default：指定預設的 server 端加密設定。 sse_algorithm：設定 server 端加密算法，這裡使用的是 “AES256”。 補充一下其他可用選項\nAES256 (SSE-S3): 描述：使用 Amazon S3 托管的密鑰（SSE-S3）進行加密。 算法：AES-256。 密鑰管理：由 Amazon S3 自動處理。 aws:kms (SSE-KMS): 描述：使用 AWS Key Management Service (KMS) 托管的 CMK（客戶主密鑰）進行加密。 算法：通常是 AES-256，但具體取決於 KMS。 密鑰管理：由 AWS KMS 處理，允許更細緻的控制和審計跟踪。 aws:kms:dsse (SSE-KMS with Double-Wrap): 描述：這是一種特殊的 KMS 加密方法，其中數據首先使用一個隨機數據加密密鑰 (DEK) 進行加密，然後 DEK 本身使用 KMS CMK 進行加密，從而實現雙重加密。 密鑰管理：由 AWS KMS 處理。 區別:\n密鑰管理：AES256 由 S3 自動管理，aws:kms 和 aws:kms:dsse 允許更多的控制和稽核，由 AWS KMS 處理。 加密強度：aws:kms:dsse 提供雙重加密，可提供更高的安全性。 推薦:\n對於大多數使用者，AES256 是一個簡單且安全的選擇。 如果需要更細緻的密鑰管理、審計或控制，則推薦使用 aws:kms。 如果需要更高的安全性和加密強度，則可以考慮使用 aws:kms:dsse，但請注意，這可能會增加一些複雜性和成本。 如果開啟 aws:kms 時，推薦也需要設定 bucket_key_enabled，可減少對 kms請求，降低成本。 當使用SSE-KMS進行 server 端加密時，每次S3對象操作都會導致KMS請求，這可能會增加成本。使用S3 Bucket Keys，可以減少這些請求，從而減少成本。\n第三個設定是存取權的控制，阻止對 S3 bucket 的所有公開存取。\nresource \"aws_s3_bucket_public_access_block\" \"public_access\" { bucket = aws_s3_bucket.bucket.id block_public_acls = true block_public_policy = true ignore_public_acls = true restrict_public_buckets = true } 參數說明如下：\nbucket：要設定公開存取阻止的 S3 bucket ID。 block_public_acls：設定為 true 阻止公開 ACL。 block_public_policy：設定為 true 阻止公開策略。 ignore_public_acls：設定為 true 忽略公開 ACL。 restrict_public_buckets：設定為 true 限制公開 bucket。 最後一個要設定的是用來當作鎖的 DynamoDB table，使用 aws_dynamodb_table 的強一制性讀取和條件寫入，達到分散式鎖系統。\nresource \"aws_dynamodb_table\" \"terraform_locks\" { name = var.dynamodb_table_name billing_mode = \"PAY_PER_REQUEST\" hash_key = \"LockID\" attribute { name = \"LockID\" type = \"S\" } } 參數說明如下：\nname：這是 DynamoDB 表的名稱。 billing_mode：這指定了計費模式，能使用的值有PROVISIONED與PAY_PER_REQUEST，這裡使用\"PAY_PER_REQUEST\"，依照需請求計費。另一種則是確定有固定的讀寫，則可以設定讀寫量。 BillingModeSummary - Amazon DynamoDB\nhash_key：這是表的主鍵名稱。 attribute： name：這是屬性的名稱，這裡是 “LockID” type：這是屬性的類型，可以用的類型有S(字串)、N(數字)、B(二進制) 依照上面的設定，即可完成s3以及dynamodb的建立，一樣下 terraform init terraform apply完成建置。接著來設定 remote backend\nterraform { backend \"s3\" { bucket = \"terraform-alan-test-bucket\" key = \"bucket-state/terraform.tfstate\" region = \"ap-east-1\" dynamodb_table = \"terraform-locks\" encrypt = true } } 參數說明如下：\nbucket：要使用的bucket name，這邊填入剛剛建立的 bucket key：要建立在 s3 的路徑和名稱 region：指定 s3 的區域 dynamodb_table：用來儲存狀態檔的鎖定，防止多人同時使用 terraform 操作同一份檔案，可防止同時修改，避免數據不一致 encrypt：決定是否加密 terraform state 檔案，設定為 true 將使用 s3 的 sse 進行加密 prefix：定義狀態檔的路徑和名稱，以上述為例，狀態檔會被存放在 bucket-state資料夾 一樣重下 terraform init 重設 backend\n\u003e terraform init Initializing the backend... Do you want to copy existing state to the new backend? Pre-existing state was found while migrating the previous \"local\" backend to the newly configured \"s3\" backend. No existing state was found in the newly configured \"s3\" backend. Do you want to copy this state to the new \"s3\" backend? Enter \"yes\" to copy and \"no\" to start with an empty state. Enter a value: 執行後terraform會自動檢查本地已有的狀態檔，並跳出提示說要將狀態檔複製到 gcs backend。如果輸入 yes，則會看到以下內容：\nSuccessfully configured the backend \"s3\"! Terraform will automatically use this backend unless the backend configuration changes. Initializing modules... Initializing provider plugins... - Reusing previous version of hashicorp/aws from the dependency lock file - Using previously-installed hashicorp/aws v5.22.0 Terraform has been successfully initialized! 一樣執行完畢後上去 s3 看一下狀態檔是否已經儲存上去\n當有兩人同時執行時，則第二個人會出現以下訊息：\n\u003e terraform apply Acquiring state lock. This may take a few moments... ╷ │ Error: Error acquiring the state lock │ │ Error message: ConditionalCheckFailedException: The conditional request failed │ Lock Info: │ ID: 46f562fd-ab59-a657-6984-5e164ec4bf │ Path: terraform-alan-test-bucket/bucket-state/terraform.tfstate │ Operation: OperationTypeApply │ Who: alan_wang@Alan-wangdeMacBook-Pro.local │ Version: 1.5.7 │ Created: 2023-10-26 09:33:34.15838 +0000 UTC │ Info: │ │ │ Terraform acquires a state lock to protect the state from being written │ by multiple users at the same time. Please resolve the issue above and try │ again. For most commands, you can disable locking with the \"-lock=false\" │ flag, but this is not recommended. ╵ 📚Reference How To Setup a Terraform Remote Backend in Google Cloud | by Żimuzo Obiechina | Medium How to Manage Terraform S3 Backend - Best Practices (spacelift.io) ","wordCount":"1143","inLanguage":"en","image":"https://sz9751210.github.io/assets/terraform-backend/cover.png","datePublished":"2023-10-28T17:10:00+08:00","dateModified":"2023-10-28T17:45:32+08:00","author":{"@type":"Person","name":"Alan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sz9751210.github.io/posts/terraform-backend/"},"publisher":{"@type":"Organization","name":"艾倫的程式之旅","logo":{"@type":"ImageObject","url":"https://sz9751210.github.io/assets/profile/avatar.png"}}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8214206744217848" crossorigin=anonymous></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sz9751210.github.io/ accesskey=h title="Alan's BLOG (Alt + H)"><img src=https://sz9751210.github.io/assets/profile/avatar.png alt aria-label=logo height=35>Alan's BLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sz9751210.github.io/archives/ title=archives><span>archives</span></a></li><li><a href=https://sz9751210.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://sz9751210.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://sz9751210.github.io/about/ title=about><span>about</span></a></li><li><a href=https://sz9751210.github.io/quote/ title=quote><span>quote</span></a></li><li><a href=https://sz9751210.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post><header class=post-header><div class=breadcrumbs><a href=https://sz9751210.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://sz9751210.github.io/posts/>Posts</a></div><h1 class=post-title>如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔</h1><div class=post-description>terraform backend</div><div class=post-meta><span title='2023-10-28 17:10:00 +0800 CST'>2023-10-28</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1143 words&nbsp;·&nbsp;Alan</div></header><figure class=entry-cover1><img loading=lazy src=https://sz9751210.github.io/assets/terraform-backend/cover.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%b0%a1%e4%bb%8b aria-label=👨‍💻簡介>👨‍💻簡介</a></li><li><a href=#gcp-gcs%e4%bd%9c%e7%82%baterraform-remote-backend aria-label="GCP GCS作為terraform remote backend">GCP GCS作為terraform remote backend</a></li><li><a href=#aws-s3%e4%bd%9c%e7%82%baterraform-remote-backend aria-label="AWS S3作為terraform remote backend">AWS S3作為terraform remote backend</a></li><li><a href=#reference aria-label=📚Reference>📚Reference</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=簡介>👨‍💻簡介<a hidden class=anchor aria-hidden=true href=#簡介>#</a></h2><p>terraform在每次執行<code>terraform plan</code>或<code>terraform apply</code>時，是如何知道應該要管理哪些資源？</p><p>其實就是透過在每次執行terraform時，將建立或要變更的資源都記錄在<code>terraform.state</code>這份狀態檔，預設檔案使用JSON格式。</p><p>假設建立一個google cloud storage的resource，tf設定檔如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>resource &#34;google_storage_bucket&#34; &#34;bucket&#34; {
</span></span><span class=line><span class=cl>  name                        = &#34;terraform-alan-test-bucket&#34;
</span></span><span class=line><span class=cl>  location                    = &#34;ASIA-EAST1&#34;
</span></span><span class=line><span class=cl>  storage_class               = &#34;STANDARD&#34; 
</span></span><span class=line><span class=cl>  public_access_prevention    = &#34;enforced&#34;
</span></span><span class=line><span class=cl>  force_destroy               = true
</span></span><span class=line><span class=cl>  uniform_bucket_level_access = true
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>建立後的terraform.tfstate的一小部分如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;terraform_version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.5.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;serial&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;lineage&#34;</span><span class=p>:</span> <span class=s2>&#34;abda0fda-b807-b8b3-0a36-8b0c2f92e3f5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;module&#34;</span><span class=p>:</span> <span class=s2>&#34;module.base-bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;mode&#34;</span><span class=p>:</span> <span class=s2>&#34;managed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;google_storage_bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;provider&#34;</span><span class=p>:</span> <span class=s2>&#34;module.base-bucket.provider[\&#34;registry.terraform.io/hashicorp/google\&#34;]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;instances&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;schema_version&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;autoclass&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;cors&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;custom_placement_config&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;default_event_based_hold&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;effective_labels&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;encryption&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;force_destroy&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;terraform-alan-test-bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;labels&#34;</span><span class=p>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;lifecycle_rule&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;location&#34;</span><span class=p>:</span> <span class=s2>&#34;ASIA-EAST1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;logging&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;terraform-alan-test-bucket&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到id的屬性，當每次執行plan或是apply時，terraform就是拿這個屬性從本地terraform設定檔與雲上資源做比對。</p><p>如果你的terraform用在個人專案，則將狀態檔存在本機即可；不過如果是一個團隊要使用terraform，則可能會遇到幾個問題：</p><ul><li>狀態檔需要共用：需要確保團隊成員都能正常存取相同的terraform狀態檔。</li><li>鎖定狀態檔：需要確保團隊成員使用terraform進行操作時，只有一人能對狀態檔做修改，否則可能會因為多個terraform進程對狀態檔做併發更新，導致資料丟失或是狀態檔損壞。</li></ul><p>要解決上述問題，常見的做法是將狀態檔進行版本控制(git)，但因為某些原因，將狀態檔進行版控並不是一個好想法。有底下幾個原因：</p><ul><li>手動操作錯誤：有時候可能在操作terraform時，忘記拉取最新狀態檔，或是在執行完terraform後，忘記將狀態檔更新到版控。可能團隊成員使用到舊的狀態檔導致資源回滾。</li><li>鎖定問題：多數的版本控制系統沒提供任何形式的鎖定，防止兩個團隊成員同時對同一份狀態檔執行操作。</li><li>加密：terraform狀態檔的資料預設都是以明文形式儲存。但某些資源需要儲存敏感資料，像是資料庫創建時需要建立初始化使用者以及密碼，這些資料不應該以明文的形式儲存在版本控制。</li></ul><p>因為以上原因，terraform官方推出 remote backend的支援，可以將狀態檔儲存在所使用的雲平台，而不是使用版本控制，而remote backend解決了剛才列出的三個問題：</p><ul><li>手動操作錯誤：terraform每次運行時會自動從 remote backend 載入狀態檔，並且每次運行後都會自動將狀態檔儲存在 remote backend，解決了手動操作錯誤。</li><li>鎖定問題：大多數 remote backend 都支援鎖定。運行terraform時會自動將檔案進行上鎖，確保只會有一人進行操作。</li><li>加密：大多數 remote backend 都支援狀態檔的傳輸中加密和靜態加密。</li></ul><p>使用gcp平台推薦使用 google cloud storage，整理的原因如下：</p><ul><li>這是託管服務，不需部署和管理額外基礎設施即可使用。</li><li>gcs旨在實現99.99%的持久性和年度耐用性。</li></ul><blockquote><p><a href="https://cloud.google.com/storage/docs/availability-durability?hl=zh-cn">数据可用性和耐用性  |  Cloud Storage  |  Google Cloud</a></p></blockquote><ul><li>gcs支援加密，預設使用server side encrypt，另外也可使用ckms服務</li></ul><blockquote><p><a href="https://cloud.google.com/storage/docs/encryption?hl=zh-cn">数据加密选项  |  Cloud Storage  |  Google Cloud</a></p></blockquote><ul><li>支援版本控制</li></ul><blockquote><p><a href="https://cloud.google.com/storage/docs/using-object-versioning?hl=zh-cn">使用对象版本控制  |  Cloud Storage  |  Google Cloud</a></p></blockquote><ul><li>費用便宜，使用免費額度即可滿足需求。</li></ul><blockquote><p><a href="https://cloud.google.com/storage/pricing?hl=zh-cn#cloud-storage-always-free">价格  |  Cloud Storage  |  Google Cloud</a></p></blockquote><h2 id=gcp-gcs作為terraform-remote-backend>GCP GCS作為terraform remote backend<a hidden class=anchor aria-hidden=true href=#gcp-gcs作為terraform-remote-backend>#</a></h2><p>要使用 Google cloud stroage作為 terraform remote backend，首先是先建立 gcs bucket。
在新資料夾中建立一個provider.tf檔案</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>google</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>source</span>  = <span class=s2>&#34;hashicorp/google&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>version</span> = <span class=s2>&#34;&gt;=4.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;google&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>region</span>  =<span class=s2>&#34;asia-east1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接著再建立一個名為bucket.tf檔案，使用 <code>google_storage_bucket</code> resource 建立 gcs bucket。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;google_storage_bucket&#34;</span> <span class=s2>&#34;bucket&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>                        = <span class=s2>&#34;terraform-alan-test-bucket&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>location</span>                    = <span class=s2>&#34;ASIA-EAST1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>storage_class</span>               = <span class=s2>&#34;STANDARD&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>public_access_prevention</span>    = <span class=s2>&#34;enforced&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>force_destroy</span>               = <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=na>uniform_bucket_level_access</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>name</code>：定義 gcs bucket 名稱</li><li><code>location</code>：指定 bucket 儲存位置</li><li><code>storage_class</code>：指定 bucket 儲存類型</li><li><code>public_access_prevention</code>：設定公開存取防止策略，<code>enforce</code>表示不允許公開訪問</li><li><code>force_destroy</code>：設定是否可強制刪除</li><li><code>uniform_bucket_level_access</code>：設定是否啟用統一訪問控制</li></ul><p>當執行完<code>terraform init</code>以及 <code>terraform apply</code>部署完後，就會看到gcs已經建立完成。但目前狀態檔還是儲存在本地。要將狀態檔儲存到 gcs bucket，需要再額外設定 remote backend，語法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>backend</span> <span class=s2>&#34;&lt;BACKEND_NAME&gt;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>CONFIG</span><span class=p>...]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>其中 <code>BACKEND_NAME</code>是要使用的資源，<code>CONFIG</code>是對這個後端的參數設定。以下是 gcs bucket的後端設定：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>terraform {
</span></span><span class=line><span class=cl>  backend &#34;gcs&#34; {
</span></span><span class=line><span class=cl>    bucket  = &#34;terraform-alan-test-bucket&#34;
</span></span><span class=line><span class=cl>    prefix  = &#34;bucket-state&#34;
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：要使用的bucket name，這邊填入剛剛建立的 bucket</li><li><code>prefix</code>：定義狀態檔的路徑和名稱，以上述為例，狀態檔會被存放在 <code>bucket-state</code>資料夾</li></ul><p>要將狀態檔儲存到 gcs ，只需要重新執行 <code>terraform init</code> 指令。該指令不僅可以下載 provider code，還可以設定 terraform backend。此外，<code>init</code>的指令是冪等的，多次執行可以確保每次都是預期的行為。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt; terraform init
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Initializing the backend...
</span></span><span class=line><span class=cl>Do you want to copy existing state to the new backend?
</span></span><span class=line><span class=cl>  Pre-existing state was found while migrating the previous &#34;local&#34; backend to the
</span></span><span class=line><span class=cl>  newly configured &#34;gcs&#34; backend. No existing state was found in the newly
</span></span><span class=line><span class=cl>  configured &#34;gcs&#34; backend. Do you want to copy this state to the new &#34;gcs&#34;
</span></span><span class=line><span class=cl>  backend? Enter &#34;yes&#34; to copy and &#34;no&#34; to start with an empty state.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Enter a value: 
</span></span></code></pre></div><p>執行後terraform會自動檢查本地已有的狀態檔，並跳出提示說要將狀態檔複製到 gcs backend。如果輸入 yes，則會看到以下內容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Successfully configured the backend &#34;gcs&#34;! Terraform will automatically
</span></span><span class=line><span class=cl>use this backend unless the backend configuration changes.
</span></span><span class=line><span class=cl>Initializing modules...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Initializing provider plugins...
</span></span><span class=line><span class=cl>- Reusing previous version of hashicorp/google from the dependency lock file
</span></span><span class=line><span class=cl>- Using previously-installed hashicorp/google v5.3.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform has been successfully initialized!
</span></span></code></pre></div><p>執行完畢後可以到 gcs查看狀態檔是否已經儲存上去。</p><p><img loading=lazy src=/assets/terraform-backend/1.png alt></p><p>如果之後有資源使用一樣的backend，terraform執行時就會自動從這個 gcs拉取最新的狀態，並且執行後會自動將最新狀態推送到這個 gcs。</p><p>當有兩人同時執行時，則第二個人會出現以下訊息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>terraform</span> <span class=nx>plan</span>
</span></span><span class=line><span class=cl><span class=nx>Acquiring</span> <span class=nx>state</span> <span class=nx>lock</span><span class=p>.</span> <span class=nx>This</span> <span class=nx>may</span> <span class=nx>take</span> <span class=nx>a</span> <span class=nx>few</span> <span class=nx>moments</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=err>╷</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>Error</span><span class=o>:</span> <span class=nx>Error</span> <span class=nx>acquiring</span> <span class=nx>the</span> <span class=nx>state</span> <span class=nx>lock</span>
</span></span><span class=line><span class=cl><span class=err>│</span> 
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>Error</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>writing</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=s2>&#34;gs://terraform-alan-test-bucket/bucket-state/default.tflock&#34;</span> <span class=nx>failed</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>googleapi</span><span class=o>:</span> <span class=nx>Error</span> <span class=m>412</span><span class=o>:</span> <span class=nx>At</span> <span class=nx>least</span> <span class=nx>one</span> <span class=nx>of</span> <span class=nx>the</span> <span class=nx>pre</span><span class=o>-</span><span class=nx>conditions</span> <span class=nx>you</span> <span class=nx>specified</span> <span class=nx>did</span> <span class=nx>not</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>hold</span><span class=p>.,</span> <span class=nx>conditionNotMet</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>Lock</span> <span class=nx>Info</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>ID</span><span class=o>:</span>        <span class=m>1698225515771180</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>Path</span><span class=o>:</span>      <span class=nx>gs</span><span class=o>:</span><span class=c1>//terraform-alan-test-bucket/bucket-state/default.tflock
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>│</span>   <span class=nx>Operation</span><span class=o>:</span> <span class=nx>OperationTypeApply</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>Who</span><span class=o>:</span>       <span class=nx>alan_wang</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>Version</span><span class=o>:</span>   <span class=m>1</span><span class=p>.</span><span class=m>5</span><span class=p>.</span><span class=m>7</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>Created</span><span class=o>:</span>   <span class=m>2023-10-25</span> <span class=m>09</span><span class=o>:</span><span class=m>18</span><span class=o>:</span><span class=m>35</span><span class=p>.</span><span class=m>490893</span> <span class=o>+</span><span class=m>0000</span> <span class=nx>UTC</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=nx>Info</span><span class=o>:</span>      
</span></span><span class=line><span class=cl><span class=err>│</span> 
</span></span><span class=line><span class=cl><span class=err>│</span> 
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>Terraform</span> <span class=nx>acquires</span> <span class=nx>a</span> <span class=nx>state</span> <span class=nx>lock</span> <span class=nx>to</span> <span class=nx>protect</span> <span class=nx>the</span> <span class=nx>state</span> <span class=nx>from</span> <span class=nx>being</span> <span class=nx>written</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>by</span> <span class=nx>multiple</span> <span class=nx>users</span> <span class=nx>at</span> <span class=nx>the</span> <span class=nx>same</span> <span class=nx>time</span><span class=p>.</span> <span class=nx>Please</span> <span class=nx>resolve</span> <span class=nx>the</span> <span class=nx>issue</span> <span class=nx>above</span> <span class=nx>and</span> <span class=nb>try</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>again</span><span class=p>.</span> <span class=nx>For</span> <span class=nx>most</span> <span class=nx>commands</span><span class=p>,</span> <span class=nx>you</span> <span class=nb>can</span> <span class=nx>disable</span> <span class=nx>locking</span> <span class=nx>with</span> <span class=nx>the</span> <span class=s2>&#34;-lock=false&#34;</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=nx>flag</span><span class=p>,</span> <span class=nx>but</span> <span class=nx>this</span> <span class=nx>is</span> <span class=nx>not</span> <span class=nx>recommended</span><span class=p>.</span>
</span></span></code></pre></div><p>這也確保了執行只會有一人，其他人要操作都會被擋下來。</p><h2 id=aws-s3作為terraform-remote-backend>AWS S3作為terraform remote backend<a hidden class=anchor aria-hidden=true href=#aws-s3作為terraform-remote-backend>#</a></h2><p>依照慣例先來個 provider.tf起手式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>aws</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>source</span> = <span class=s2>&#34;hashicorp/aws&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>version</span> = <span class=s2>&#34;5.22.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;aws&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>alias</span>  = <span class=s2>&#34;ap-east-1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>region</span> = <span class=s2>&#34;ap-east-1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接著建立一個名為bucket.tf檔案</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>resource &#34;aws_s3_bucket&#34; &#34;terraform_state&#34; {
</span></span><span class=line><span class=cl>  bucket = &#34;terraform-alan-test-bucket&#34;
</span></span><span class=line><span class=cl>  provider = aws.ap-east-1
</span></span><span class=line><span class=cl>  force_destroy = false
</span></span><span class=line><span class=cl>  # Prevent accidental deletion of this S3 bucket
</span></span><span class=line><span class=cl>  lifecycle {
</span></span><span class=line><span class=cl>    prevent_destroy = true
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：定義 s3 bucket 名稱</li><li><code>provider</code>：指定 bucket 儲存位置</li><li><code>force_destroy</code>：設定是否可強制刪除</li><li><code>prevent_destroy</code>：任何嘗試刪除該資源的操作都將導致terraform退出並顯示錯誤。</li></ul><p>接下來要替s3增加一些額外的保護</p><p>首先新增版本控制，使用<code>aws_s3_bucket_versioning</code> resource開啟版本控制，確保每次更新都會創建新版。當出現問題時也能恢復成舊版：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_s3_bucket_versioning&#34;</span> <span class=s2>&#34;enabled&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>bucket</span> = <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>terraform_state</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>versioning_configuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>status</span> = <span class=s2>&#34;Enabled&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：要啟用版本控制的 S3 bucket 的 ID</li><li><code>versioning_configuration</code>：<ul><li><code>status</code>：可用選項為<code>Enabled</code>、<code>Disabled</code>與<code>Suspended</code>，設為 &ldquo;Enabled&rdquo; 表示啟用版本控制</li></ul></li></ul><p>接著開啟加密設定，使用 <code>aws_s3_bucket_server_side_encryption_configuration</code>，開啟後寫入到這個 S3 的所有資料都會啟用 server 端的加密。確保狀態檔以及任何存在 S3 的敏感資料都在硬碟上加密：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>resource &#34;aws_s3_bucket_server_side_encryption_configuration&#34; &#34;server_side_encryption&#34; {
</span></span><span class=line><span class=cl>  bucket = aws_s3_bucket.terraform_state.id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  rule {
</span></span><span class=line><span class=cl>    apply_server_side_encryption_by_default {
</span></span><span class=line><span class=cl>      sse_algorithm = &#34;AES256&#34;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：要啟用版本控制的 S3 bucket 的 ID</li><li><code>apply_server_side_encryption_by_default</code>：指定預設的 server 端加密設定。<ul><li><code>sse_algorithm</code>：設定 server 端加密算法，這裡使用的是 &ldquo;AES256&rdquo;。</li></ul></li></ul><p>補充一下其他可用選項</p><ol><li><strong>AES256 (SSE-S3)</strong>:<ul><li>描述：使用 Amazon S3 托管的密鑰（SSE-S3）進行加密。</li><li>算法：AES-256。</li><li>密鑰管理：由 Amazon S3 自動處理。</li></ul></li><li><strong>aws:kms (SSE-KMS)</strong>:<ul><li>描述：使用 AWS Key Management Service (KMS) 托管的 CMK（客戶主密鑰）進行加密。</li><li>算法：通常是 AES-256，但具體取決於 KMS。</li><li>密鑰管理：由 AWS KMS 處理，允許更細緻的控制和審計跟踪。</li></ul></li><li><strong>aws:kms:dsse (SSE-KMS with Double-Wrap)</strong>:<ul><li>描述：這是一種特殊的 KMS 加密方法，其中數據首先使用一個隨機數據加密密鑰 (DEK) 進行加密，然後 DEK 本身使用 KMS CMK 進行加密，從而實現雙重加密。</li><li>密鑰管理：由 AWS KMS 處理。</li></ul></li></ol><p><strong>區別</strong>:</p><ul><li><strong>密鑰管理</strong>：<code>AES256</code> 由 S3 自動管理，<code>aws:kms</code> 和 <code>aws:kms:dsse</code> 允許更多的控制和稽核，由 AWS KMS 處理。</li><li><strong>加密強度</strong>：<code>aws:kms:dsse</code> 提供雙重加密，可提供更高的安全性。</li></ul><p><strong>推薦</strong>:</p><ul><li>對於大多數使用者，<strong>AES256</strong> 是一個簡單且安全的選擇。</li><li>如果需要更細緻的密鑰管理、審計或控制，則推薦使用 <strong>aws:kms</strong>。</li><li>如果需要更高的安全性和加密強度，則可以考慮使用 <strong>aws:kms:dsse</strong>，但請注意，這可能會增加一些複雜性和成本。</li></ul><p>如果開啟 <strong>aws:kms</strong> 時，推薦也需要設定 <code>bucket_key_enabled</code>，可減少對 kms請求，降低成本。
當使用SSE-KMS進行 server 端加密時，每次S3對象操作都會導致KMS請求，這可能會增加成本。使用S3 Bucket Keys，可以減少這些請求，從而減少成本。</p><p>第三個設定是存取權的控制，阻止對 S3 bucket 的所有公開存取。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_s3_bucket_public_access_block&#34;</span> <span class=s2>&#34;public_access&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>bucket</span>                  = <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>bucket</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>block_public_acls</span>       = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>block_public_policy</span>     = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>ignore_public_acls</span>      = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=na>restrict_public_buckets</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：要設定公開存取阻止的 S3 bucket ID。</li><li><code>block_public_acls</code>：設定為 <code>true</code> 阻止公開 ACL。</li><li><code>block_public_policy</code>：設定為 <code>true</code> 阻止公開策略。</li><li><code>ignore_public_acls</code>：設定為 <code>true</code> 忽略公開 ACL。</li><li><code>restrict_public_buckets</code>：設定為 <code>true</code> 限制公開 bucket。</li></ul><p>最後一個要設定的是用來當作鎖的 DynamoDB table，使用 <code>aws_dynamodb_table</code> 的強一制性讀取和條件寫入，達到分散式鎖系統。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_dynamodb_table&#34;</span> <span class=s2>&#34;terraform_locks&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>           = <span class=nb>var</span><span class=p>.</span><span class=nx>dynamodb_table_name</span>
</span></span><span class=line><span class=cl>  <span class=na>billing_mode</span>   = <span class=s2>&#34;PAY_PER_REQUEST&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>hash_key</span>       = <span class=s2>&#34;LockID&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>attribute</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span> = <span class=s2>&#34;LockID&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>type</span> = <span class=s2>&#34;S&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>name</code>：這是 DynamoDB 表的名稱。</li><li><code>billing_mode</code>：這指定了計費模式，能使用的值有<code>PROVISIONED</code>與<code>PAY_PER_REQUEST</code>，這裡使用"PAY_PER_REQUEST"，依照需請求計費。另一種則是確定有固定的讀寫，則可以設定讀寫量。</li></ul><blockquote><p><a href=https://docs.aws.amazon.com/zh_tw/amazondynamodb/latest/APIReference/API_BillingModeSummary.html>BillingModeSummary - Amazon DynamoDB</a></p></blockquote><ul><li><code>hash_key</code>：這是表的主鍵名稱。</li><li><code>attribute</code>：<ul><li><code>name</code>：這是屬性的名稱，這裡是 &ldquo;LockID&rdquo;</li><li><code>type</code>：這是屬性的類型，可以用的類型有<code>S</code>(字串)、<code>N</code>(數字)、<code>B</code>(二進制)</li></ul></li></ul><p>依照上面的設定，即可完成s3以及dynamodb的建立，一樣下 <code>terraform init</code> <code>terraform apply</code>完成建置。接著來設定 remote backend</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>backend</span> <span class=s2>&#34;s3&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>bucket</span>         = <span class=s2>&#34;terraform-alan-test-bucket&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>key</span>            = <span class=s2>&#34;bucket-state/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>region</span>         = <span class=s2>&#34;ap-east-1&#34;</span> 
</span></span><span class=line><span class=cl>    <span class=na>dynamodb_table</span> = <span class=s2>&#34;terraform-locks&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>encrypt</span>        = <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>參數說明如下：</p><ul><li><code>bucket</code>：要使用的bucket name，這邊填入剛剛建立的 bucket</li><li><code>key</code>：要建立在 s3 的路徑和名稱</li><li><code>region</code>：指定 s3 的區域</li><li><code>dynamodb_table</code>：用來儲存狀態檔的鎖定，防止多人同時使用 terraform 操作同一份檔案，可防止同時修改，避免數據不一致</li><li><code>encrypt</code>：決定是否加密 terraform state 檔案，設定為 <code>true</code> 將使用 s3 的 sse 進行加密</li><li><code>prefix</code>：定義狀態檔的路徑和名稱，以上述為例，狀態檔會被存放在 <code>bucket-state</code>資料夾</li></ul><p>一樣重下 <code>terraform init</code> 重設 backend</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt; terraform init
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Initializing the backend...
</span></span><span class=line><span class=cl>Do you want to copy existing state to the new backend?
</span></span><span class=line><span class=cl>  Pre-existing state was found while migrating the previous &#34;local&#34; backend to the
</span></span><span class=line><span class=cl>  newly configured &#34;s3&#34; backend. No existing state was found in the newly
</span></span><span class=line><span class=cl>  configured &#34;s3&#34; backend. Do you want to copy this state to the new &#34;s3&#34;
</span></span><span class=line><span class=cl>  backend? Enter &#34;yes&#34; to copy and &#34;no&#34; to start with an empty state.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Enter a value:
</span></span></code></pre></div><p>執行後terraform會自動檢查本地已有的狀態檔，並跳出提示說要將狀態檔複製到 gcs backend。如果輸入 yes，則會看到以下內容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Successfully configured the backend &#34;s3&#34;! Terraform will automatically
</span></span><span class=line><span class=cl>use this backend unless the backend configuration changes.
</span></span><span class=line><span class=cl>Initializing modules...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Initializing provider plugins...
</span></span><span class=line><span class=cl>- Reusing previous version of hashicorp/aws from the dependency lock file
</span></span><span class=line><span class=cl>- Using previously-installed hashicorp/aws v5.22.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform has been successfully initialized!
</span></span></code></pre></div><p>一樣執行完畢後上去 s3 看一下狀態檔是否已經儲存上去</p><p><img loading=lazy src=/assets/terraform-backend/2.png alt></p><p>當有兩人同時執行時，則第二個人會出現以下訊息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt; terraform apply
</span></span><span class=line><span class=cl>Acquiring state lock. This may take a few moments...
</span></span><span class=line><span class=cl>╷
</span></span><span class=line><span class=cl>│ Error: Error acquiring the state lock
</span></span><span class=line><span class=cl>│ 
</span></span><span class=line><span class=cl>│ Error message: ConditionalCheckFailedException: The conditional request failed
</span></span><span class=line><span class=cl>│ Lock Info:
</span></span><span class=line><span class=cl>│   ID:        46f562fd-ab59-a657-6984-5e164ec4bf
</span></span><span class=line><span class=cl>│   Path:      terraform-alan-test-bucket/bucket-state/terraform.tfstate
</span></span><span class=line><span class=cl>│   Operation: OperationTypeApply
</span></span><span class=line><span class=cl>│   Who:       alan_wang@Alan-wangdeMacBook-Pro.local
</span></span><span class=line><span class=cl>│   Version:   1.5.7
</span></span><span class=line><span class=cl>│   Created:   2023-10-26 09:33:34.15838 +0000 UTC
</span></span><span class=line><span class=cl>│   Info:      
</span></span><span class=line><span class=cl>│ 
</span></span><span class=line><span class=cl>│ 
</span></span><span class=line><span class=cl>│ Terraform acquires a state lock to protect the state from being written
</span></span><span class=line><span class=cl>│ by multiple users at the same time. Please resolve the issue above and try
</span></span><span class=line><span class=cl>│ again. For most commands, you can disable locking with the &#34;-lock=false&#34;
</span></span><span class=line><span class=cl>│ flag, but this is not recommended.
</span></span><span class=line><span class=cl>╵
</span></span></code></pre></div><h2 id=reference>📚Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://ziimm.medium.com/how-to-setup-a-terraform-remote-backend-in-google-cloud-6bb3f1829d5c>How To Setup a Terraform Remote Backend in Google Cloud | by Żimuzo Obiechina | Medium</a></li><li><a href=https://spacelift.io/blog/terraform-s3-backend>How to Manage Terraform S3 Backend - Best Practices (spacelift.io)</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://sz9751210.github.io/tags/terraform/>terraform</a></li><li><a href=https://sz9751210.github.io/tags/gcp/>gcp</a></li><li><a href=https://sz9751210.github.io/tags/aws/>aws</a></li></ul><div class=post-meta>更新於: 2023-10-28</div><nav class=paginav><a class=prev href=https://sz9751210.github.io/posts/k8s-rbac/><span class=title>« Prev</span><br><span>Kubernetes RBAC Overview：賦予安全與彈性的管理</span>
</a><a class=next href=https://sz9751210.github.io/posts/go-ptt-crawler/><span class=title>Next »</span><br><span>如何用 Go 實作一個簡單的 PTT 爬蟲</span></a></nav><script src=https://utteranc.es/client.js repo=sz9751210/utterances issue-term=title theme=github-dark crossorigin=anonymous async></script><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on twitter" href="https://twitter.com/intent/tweet/?text=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f&amp;hashtags=terraform%2cgcp%2caws"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f&amp;title=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94&amp;summary=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94&amp;source=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f&title=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on whatsapp" href="https://api.whatsapp.com/send?text=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94%20-%20https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 如何在GCP以及AWS設定 remote backend 管理 terraform 狀態檔 on telegram" href="https://telegram.me/share/url?text=%e5%a6%82%e4%bd%95%e5%9c%a8GCP%e4%bb%a5%e5%8f%8aAWS%e8%a8%ad%e5%ae%9a%20remote%20backend%20%e7%ae%a1%e7%90%86%20terraform%20%e7%8b%80%e6%85%8b%e6%aa%94&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2fterraform-backend%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sz9751210.github.io/>艾倫的程式之旅</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let detail=document.getElementsByClassName("details");details=[].slice.call(detail);for(let e=0;e<details.length;e++){let t=details[e];const n=t.getElementsByClassName("details-summary")[0];n&&n.addEventListener("click",()=>{t.classList.toggle("open")},!1)}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>