<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info | 艾倫的程式之旅</title>
<meta name=keywords content="憑證監控,讀取 MongoDB Domain Info"><meta name=description content="Telegram 憑證監控機器人 - 實作 EP1 - 讀取 MongoDB Domain Info"><meta name=author content="Alan"><link rel=canonical href=https://sz9751210.github.io/posts/tg-bot-ep1/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=icon type=image/png sizes=32x32 href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=apple-touch-icon href=https://sz9751210.github.io/assets/profile/avatar.png><link rel=mask-icon href=https://sz9751210.github.io/assets/profile/avatar.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-4RLTP9J7DY"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4RLTP9J7DY",{anonymize_ip:!1})}</script><meta property="og:title" content="Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info"><meta property="og:description" content="Telegram 憑證監控機器人 - 實作 EP1 - 讀取 MongoDB Domain Info"><meta property="og:type" content="article"><meta property="og:url" content="https://sz9751210.github.io/posts/tg-bot-ep1/"><meta property="og:image" content="https://sz9751210.github.io/assets/tg-bot-ep1/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-06T15:45:00+08:00"><meta property="article:modified_time" content="2024-05-14T21:13:39+08:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sz9751210.github.io/assets/tg-bot-ep1/cover.png"><meta name=twitter:title content="Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info"><meta name=twitter:description content="Telegram 憑證監控機器人 - 實作 EP1 - 讀取 MongoDB Domain Info"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sz9751210.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info","item":"https://sz9751210.github.io/posts/tg-bot-ep1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info","name":"Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info","description":"Telegram 憑證監控機器人 - 實作 EP1 - 讀取 MongoDB Domain Info","keywords":["憑證監控","讀取 MongoDB Domain Info"],"articleBody":"👨‍💻 簡介 上次做的憑證監控已經可以正常運作了，但這次希望能夠不從 yaml 讀取 domain info，而是從 MongoDB 進行讀取，方便未來的擴充性。\n這次的重點是要透過 Python 連接 MongoDB，並且透過 Python 讀取 MongoDB，最後透過 Python 寫入 MongoDB。\n🛠️ 使用工具 Python 3.9.6 MongoDB Mongoshell Docker Docker-Compose 📝 功能需求 建立 MongoDB docker-compose 透過 Python 連接 MongoDB 透過 Python 讀取 yaml 並寫入 MongoDB 透過 Python 傳入 env 以及 domain 寫入 MongoDB 透過 Python 讀取 MongoDB 透過 Python 修改 MongoDB 透過 Python 刪除 MongoDB 🎯Setup 建立 MongoDB docker-compose 要簡單使用 MongoDB 可以用 docker-compose 快速拉起： version: \"3.1\" services: mongodb: image: mongo:latest container_name: mongodb_container environment: MONGO_INITDB_ROOT_USERNAME: rootuser MONGO_INITDB_ROOT_PASSWORD: rootpass ports: - \"27017:27017\" volumes: - mongodb_data_container:/data/db volumes: mongodb_data_container: docker-compose up -d 透過 Python 連接 MongoDB 在 Python Library 中，可以使用 PyMongo操作 MongoDB。 要使用這個 Library 要先透過安裝： python3 -m pip install pymongo 接著可以簡單操作一筆資料看是否正常：\n# 導入 pymongo 模塊中的 MongoClient 類，用於與 MongoDB 資料庫進行連接 from pymongo import MongoClient from pymongo.errors import ConnectionFailure # 定義 MongoDB 連接 URI，包含用戶名、密碼、服務器地址、端口和資料庫名 mongodb_uri = \"mongodb://rootuser:rootpass@localhost:27017/mydatabase?authSource=admin\" try: # 嘗試連接 MongoDB client = MongoClient(mongodb_uri) # 嘗試獲取服務器訊息，以確認連接 info = client.server_info() # 會在連接失敗時拋出 ConnectionFailure 異常 print(\"MongoDB 連接成功。Server Info：\", info) except ConnectionFailure: print(\"MongoDB 連接失敗。請檢查您的連接設置和Server狀態。\") 輸出如下：\nMongoDB 連接成功。Server Info： {'version': '7.0.8', 'gitVersion': 'c5d33e55ba38d98e2f48765ec4e55338d67a4a64', 'modules': [], 'allocator': 'tcmalloc', 'javascriptEngine': 'mozjs', 'sysInfo': 'deprecated', 'versionArray': [7, 0, 8, 0], 'openssl': {'running': 'OpenSSL 3.0.2 15 Mar 2022', 'compiled': 'OpenSSL 3.0.2 15 Mar 2022'}, 'buildEnvironment': {'distmod': 'ubuntu2204', 'distarch': 'aarch64', 'cc': '/opt/mongodbtoolchain/v4/ bin/gcc: gcc (GCC) 11.3.0', 'ccflags': '-Werror -include mongo/platform/basic.h -ffp-contract=off ... 稍微包裝一下：\nfrom pymongo import MongoClient from pymongo.errors import ConnectionFailure mongodb_uri = \"mongodb://rootuser:rootpass@localhost:27017/mydatabase?authSource=admin\" def init_mongo_client(mongodb_uri): try: # 嘗試連接 MongoDB client = MongoClient(mongodb_uri) # 嘗試獲取服務器訊息，以確認連接 info = client.server_info() # 會在連接失敗時拋出 ConnectionFailure 異常 mongodb_version = info['version'] print(\"MongoDB 連接成功。Mongo 版本為\", mongodb_version) return client except ConnectionFailure: print(\"MongoDB 連接失敗。請檢查您的連接設置和Server狀態。\") client = init_mongo_client(mongodb_uri) 這樣就代表我們成功連線到 MongoDB 了。\n透過 Python 讀取 yaml 並寫入 MongoDB 接下來我想要將讀取的 domains.yaml 寫入 Ｍ ongo ，會用到之前的 load_data_from_yaml： client = init_mongo_client(mongodb_uri) db = client.get_default_database() # 定義要操作的集合名稱 collection_name = \"domains\" collection = db[collection_name] yaml_file_path = \"domains.yaml\" domain_data = load_data_from_yaml(yaml_file_path, \"domain_envs\") # 每次執行迴圈都會取得一個鍵值對，env 是 key，格式為 string， # 而 value 則會是 domains，格式是 list for env, domains in domain_data.items(): print(f\"Writing domains for env {env}: {domains}\") # 這裡組成一個 document，方便儲存到 Mongo 裡 document = { \"env\": env, \"domains\": domains } # 更新條件，匹配那些 env 字段等於當前 env 值的 document query = {\"env\": env} # 將匹配的 document 的內容設為 `document` 字典中的內容 # 使用 upsert=True，如果不存在則插入，存在則更新 collection.update_one(query, {\"$set\": document}, upsert=True) print(\"資料已成功寫入 MongoDB。\") 在 Mongo 中，如果指定的集合 (collection) 不存在，當你進行第一次寫入操作（如插入文檔）時，MongoDB 會自動創建這個集合。 集合的創建是懶惰的（lazy），意味著直到你對集合進行了第一次寫入操作（例如使用 `insert_one`、`insert_many`、`update_one` 等方法），集合才會被實際創建。 這種設計使得在 MongoDB 中處理集合非常靈活，你不需要事先創建集合就可以開始開發和測試你的應用程序。MongoDB 會根據需要自動管理集合的創建。 儲存要注意的地方是格式，這裡因為使用的是 Mongo，所以我們這邊將讀取的格式組成一個 document。 在 Mongo 中，每個 document 都是以 BSON(Binary JSON) 格式儲存，這是一種類似於 JSON 的格式。 每個文檔都是由鍵值對（key-value pairs）組成的資料結構，其中每個鍵（key）是一個字符串，而值（value）可以是不同類型的資料類型，包括但不限於字符串、數字、布爾值、列表（在 BSON 中稱為）、甚至是嵌套的文檔。 可參考官方文檔[官方文檔](https://www.mongodb.com/docs/manual/reference/bson-types/#bson-types)。 update_one基本語法如下：\ncollection.update_one(filter, update, upsert=False) filter：一個字典，用於指定查詢條件，以匹配需要更新的文檔。 update：一個字典，用於指定如何更新匹配的文檔。這通常涉及到 MongoDB 的更新操作符，如 $set、$unset 等。 upsert：一個可選的 boolean 值，默認為 False。如果設置為 True，當沒有文檔匹配 filter 查詢條件時，update 操作將會作為一個新的 doc 被插入到集合中。 寫入成功後可以透過 MongoShell 或是 Mongo Compass，這邊使用 MongoShell，在 docker-compose.yaml 添加 MongoShell 的 service：\nservices: mongoshell: image: mongo:latest container_name: mongodb_mongoshell depends_on: - mongodb entrypoint: [ \"mongosh\", \"--host\", \"mongodb\", \"--username\", \"rootuser\", \"--password\", \"rootpass\", \"--authenticationDatabase\", \"admin\", ] stdin_open: true tty: true 接著透過以下指令進入 mongoshell：\ndocker-compose run mongoshell 要查看 collection 需執行以下 query：\nuse mydatabase db.domains.find({}) 這段代碼用意如下：\n選擇 mydatabase db 查詢 domains collection 中所有的 document 輸出類似以下訊息：\n[ { _id: ObjectId('66150a22e1a8ac17b898a2f0'), env: 'live', domains: [ 'google.com', 'en.wikipedia.org' ] } ] 讓我們稍微優化一下程式碼：\ndef write_domain_data_to_mongodb(mongo_client, collection_name, domain_data): db = mongo_client.get_default_database() collection = db[collection_name] for env, domains in domain_data.items(): document = { \"env\": env, \"domains\": domains } # 更新條件，這裡假設 env 是唯一的 query = {\"env\": env} # 使用 upsert=True，如果不存在則插入，存在則更新 collection.update_one(query, {\"$set\": document}, upsert=True) print(\"數據已成功寫入 MongoDB。\") client = init_mongo_client(mongodb_uri) collection_name = \"domains\" yaml_file_path = \"domains.yaml\" domain_data = load_data_from_yaml(yaml_file_path, \"domain_envs\") write_domain_data_to_mongodb(client, collection_name, domain_data) 這樣就完成了從 yaml 進行寫入，接著需要撰寫另一套，透過傳入 env 以及 domain 資訊來進行寫入。\n透過 Python 傳入 env 以及 domain 寫入 MongoDB 會需要這個功能是因為之後要透過 TG Bot 傳入 env 以及 domain 進行寫入的操作： def add_domain_to_mongodb(collection, env, domain): # 嘗試添加或更新該 env 的域名 result = collection.update_one( {\"env\": env}, {\"$addToSet\": {\"domains\": domain}}, upsert=True ) if result.matched_count \u003e 0 or result.upserted_id is not None: print(\"域名已成功添加或更新。\") return True else: print(\"域名添加或更新失敗。\") return False client = init_mongo_client(mongodb_uri) db = client.get_default_database() collection_name = \"domains\" collection = db[collection_name] add_env = \"dev\" add_domain = \"test.com\" add_domain_to_mongodb(collection, add_env, add_domain) 使用 addToSet 是為了確保新增時，如果已存在不會重複新增，確保每個 domain 的唯一性。\n新增的部分告一段落，接著來進行讀取的部分。\n透過 Python 讀取 MongoDB 讀取可以透過 collection.find({}) 進行查詢： db = client.get_default_database() collection = db[collection_name] try: domain_envs = {} data = collection.find({}) for item in data: env = item.get(\"env\") domains = item.get(\"domains\", []) if env and domains: domain_envs[env] = domains print(domain_envs) except Exception as e: print(f\"從 MongoDB 讀取數據失敗: {e}\") finally: client.close() 接著優化一下代碼：\ndef load_domain_envs_from_mongodb(mongo_client, collection_name): db = mongo_client.get_default_database() collection = db[collection_name] try: domain_envs = {} data = collection.find({}) for item in data: env = item.get(\"env\") domains = item.get(\"domains\", []) if env and domains: domain_envs[env] = domains return domain_envs except Exception as e: print(f\"從 MongoDB 讀取數據失敗: {e}\") return {} finally: client.close() 這樣就算是完成了基本的讀取，接下來要做取得單一 domain 資訊：\ndef get_domain_from_mongodb(collection, env, domain): # 構造查詢條件 query = {\"env\": env, \"domains\": domain} # 執行查詢操作 result = collection.find_one(query) print(\"get result\",result) if result: # 找到了相應的文檔，返回域名訊息 print(f\"在環境 '{env}' 下找到域名 '{domain}' 的訊息。\") return result else: # 沒有找到相應的文檔 print(f\"在環境 '{env}' 下未找到域名 '{domain}' 的訊息。\") return None client = init_mongo_client(mongodb_uri) db = client.get_default_database() collection_name = \"domains\" collection = db[collection_name] get_env = \"live\" get_domain = \"google.com\" get_domain_from_mongodb(collection, get_env, get_domain) 讀取的部分告一段落，接著來進行修改的部分。\n透過 Python 修改 MongoDB 假設我們目前的 MongoDB 資料如下： [ { _id: ObjectId('66150a22e1a8ac17b898a2f0'), env: 'live', domains: [ 'google.com', 'en.wikipedia.org' ] } ] 我打算將 google.com 改成 github.com，只需要將原本用來新增的 update_one 裡的 query 多一個 domains 欄位：\ndef update_domain_in_mongodb(collection, env_value, old_domain, new_domain): # 建立查詢條件和更新動作 query = {\"env\": env_value, \"domains\": old_domain} update_action = {\"$set\": {\"domains.$\": new_domain}} # 執行更新操作 update_result = collection.update_many(query, update_action) if update_result.matched_count \u003e 0: print( f\"成功更新文檔。匹配數量: {update_result.matched_count}, 修改數量: {update_result.modified_count}.\" ) else: print(\"未找到匹配的文檔或域名，更新未執行。\") db = client.get_default_database() collection = db[collection_name] env_value = \"live\" origin_domain = \"google.com\" new_domain = \"github.com\" update_domain_in_mongodb(collection, env_value, origin_domain, new_domain) 這裡有用到 $ 佔位符，主要是將查詢語句的第一個值來做 update， 會先查找 env 等於 env_value 並且 domains 等於 old_domain， 接著將 domains list 中第一個匹配的 old_domain 元素更新為 new_domain。\n可參考官網的操作符文檔。\n透過 Python 刪除 MongoDB 最後一步要做的是刪除，能夠在指定的 env 刪除 domain： def delete_domain_in_mongodb(collection, env_value, domain_to_delete): query = {\"env\": env_value} delete_action = {\"$pull\": {\"domains\": domain_to_delete}} collection.update_one(query, delete_action) db = client.get_default_database() collection = db[collection_name] env_value = \"live\" delete_domain = \"github.com\" delete_domain_in_mongodb(collection, env_value, delete_domain) 刪除一樣用 update 方法，然後使用 $pull 操作符，刪除指定的項目，官方文檔在這。\nMongoDB 操作的部分就先告一段落，下篇會教如何打造屬於自己的 Telegram Bot，讓我的機器人能夠接收指令。\n如果想看完整程式碼可以參考這裡 🔗 專案 repo –\u003e ep1-mongo-setup\n📚Reference MongoDB 手册 PyMongo 4.6.3 documentation The mongo Shell — MongoDB Manual ","wordCount":"953","inLanguage":"en","image":"https://sz9751210.github.io/assets/tg-bot-ep1/cover.png","datePublished":"2024-05-06T15:45:00+08:00","dateModified":"2024-05-14T21:13:39+08:00","author":{"@type":"Person","name":"Alan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sz9751210.github.io/posts/tg-bot-ep1/"},"publisher":{"@type":"Organization","name":"艾倫的程式之旅","logo":{"@type":"ImageObject","url":"https://sz9751210.github.io/assets/profile/avatar.png"}}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8214206744217848" crossorigin=anonymous></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sz9751210.github.io/ accesskey=h title="Alan's BLOG (Alt + H)"><img src=https://sz9751210.github.io/assets/profile/avatar.png alt aria-label=logo height=35>Alan's BLOG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sz9751210.github.io/archives/ title=archives><span>archives</span></a></li><li><a href=https://sz9751210.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://sz9751210.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://sz9751210.github.io/about/ title=about><span>about</span></a></li><li><a href=https://sz9751210.github.io/quote/ title=quote><span>quote</span></a></li><li><a href=https://sz9751210.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post><header class=post-header><div class=breadcrumbs><a href=https://sz9751210.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://sz9751210.github.io/posts/>Posts</a></div><h1 class=post-title>Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info</h1><div class=post-description>Telegram 憑證監控機器人 - 實作 EP1 - 讀取 MongoDB Domain Info</div><div class=post-meta><span title="2024-05-06 15:45:00 +0800 CST">2024-05-06</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;953 words&nbsp;·&nbsp;Alan</div></header><figure class=entry-cover1><img loading=lazy src=https://sz9751210.github.io/assets/tg-bot-ep1/cover.png alt></figure><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#-%e7%b0%a1%e4%bb%8b aria-label="👨‍💻 簡介">👨‍💻 簡介</a></li><li><a href=#-%e4%bd%bf%e7%94%a8%e5%b7%a5%e5%85%b7 aria-label="🛠️ 使用工具">🛠️ 使用工具</a></li><li><a href=#-%e5%8a%9f%e8%83%bd%e9%9c%80%e6%b1%82 aria-label="📝 功能需求">📝 功能需求</a></li><li><a href=#setup aria-label=🎯Setup>🎯Setup</a></li><li><a href=#reference aria-label=📚Reference>📚Reference</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=-簡介>👨‍💻 簡介<a hidden class=anchor aria-hidden=true href=#-簡介>#</a></h2><p>上次做的憑證監控已經可以正常運作了，但這次希望能夠不從 yaml 讀取 domain info，而是從 MongoDB 進行讀取，方便未來的擴充性。</p><p>這次的重點是要透過 Python 連接 MongoDB，並且透過 Python 讀取 MongoDB，最後透過 Python 寫入 MongoDB。</p><h2 id=-使用工具>🛠️ 使用工具<a hidden class=anchor aria-hidden=true href=#-使用工具>#</a></h2><ul><li>Python 3.9.6</li><li>MongoDB</li><li>Mongoshell</li><li>Docker</li><li>Docker-Compose</li></ul><h2 id=-功能需求>📝 功能需求<a hidden class=anchor aria-hidden=true href=#-功能需求>#</a></h2><ul><li>建立 MongoDB docker-compose</li><li>透過 Python 連接 MongoDB</li><li>透過 Python 讀取 yaml 並寫入 MongoDB</li><li>透過 Python 傳入 env 以及 domain 寫入 MongoDB</li><li>透過 Python 讀取 MongoDB</li><li>透過 Python 修改 MongoDB</li><li>透過 Python 刪除 MongoDB</li></ul><h2 id=setup>🎯Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><ol><li>建立 MongoDB docker-compose
要簡單使用 MongoDB 可以用 docker-compose 快速拉起：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongodb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb_container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_USERNAME</span><span class=p>:</span><span class=w> </span><span class=l>rootuser</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>MONGO_INITDB_ROOT_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>rootpass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;27017:27017&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mongodb_data_container:/data/db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongodb_data_container</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker-compose up -d
</span></span></code></pre></div><ol start=2><li>透過 Python 連接 MongoDB
在 Python Library 中，可以使用 <a href=https://pymongo.readthedocs.io/en/stable/index.html>PyMongo</a>操作 MongoDB。
要使用這個 Library 要先透過安裝：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>python3 -m pip install pymongo
</span></span></code></pre></div><p>接著可以簡單操作一筆資料看是否正常：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 導入 pymongo 模塊中的 MongoClient 類，用於與 MongoDB 資料庫進行連接</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pymongo</span> <span class=kn>import</span> <span class=n>MongoClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pymongo.errors</span> <span class=kn>import</span> <span class=n>ConnectionFailure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定義 MongoDB 連接 URI，包含用戶名、密碼、服務器地址、端口和資料庫名</span>
</span></span><span class=line><span class=cl><span class=n>mongodb_uri</span> <span class=o>=</span> <span class=s2>&#34;mongodb://rootuser:rootpass@localhost:27017/mydatabase?authSource=admin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 嘗試連接 MongoDB</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>MongoClient</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 嘗試獲取服務器訊息，以確認連接</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>server_info</span><span class=p>()</span>  <span class=c1># 會在連接失敗時拋出 ConnectionFailure 異常</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MongoDB 連接成功。Server Info：&#34;</span><span class=p>,</span> <span class=n>info</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>ConnectionFailure</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MongoDB 連接失敗。請檢查您的連接設置和Server狀態。&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>輸出如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>MongoDB 連接成功。Server Info： <span class=o>{</span><span class=s1>&#39;version&#39;</span>: <span class=s1>&#39;7.0.8&#39;</span>, <span class=s1>&#39;gitVersion&#39;</span>:
</span></span><span class=line><span class=cl><span class=s1>&#39;c5d33e55ba38d98e2f48765ec4e55338d67a4a64&#39;</span>, <span class=s1>&#39;modules&#39;</span>: <span class=o>[]</span>, <span class=s1>&#39;allocator&#39;</span>: <span class=s1>&#39;tcmalloc&#39;</span>,
</span></span><span class=line><span class=cl><span class=s1>&#39;javascriptEngine&#39;</span>: <span class=s1>&#39;mozjs&#39;</span>, <span class=s1>&#39;sysInfo&#39;</span>: <span class=s1>&#39;deprecated&#39;</span>, <span class=s1>&#39;versionArray&#39;</span>: <span class=o>[</span>7, 0, 8, 0<span class=o>]</span>, <span class=s1>&#39;openssl&#39;</span>:
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s1>&#39;running&#39;</span>: <span class=s1>&#39;OpenSSL 3.0.2 15 Mar 2022&#39;</span>, <span class=s1>&#39;compiled&#39;</span>: <span class=s1>&#39;OpenSSL 3.0.2 15 Mar 2022&#39;</span><span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s1>&#39;buildEnvironment&#39;</span>: <span class=o>{</span><span class=s1>&#39;distmod&#39;</span>: <span class=s1>&#39;ubuntu2204&#39;</span>, <span class=s1>&#39;distarch&#39;</span>: <span class=s1>&#39;aarch64&#39;</span>, <span class=s1>&#39;cc&#39;</span>: <span class=s1>&#39;/opt/mongodbtoolchain/v4/
</span></span></span><span class=line><span class=cl><span class=s1>bin/gcc: gcc (GCC) 11.3.0&#39;</span>, <span class=s1>&#39;ccflags&#39;</span>: <span class=err>&#39;</span>-Werror -include mongo/platform/basic.h -ffp-contract<span class=o>=</span>off
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>稍微包裝一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pymongo</span> <span class=kn>import</span> <span class=n>MongoClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pymongo.errors</span> <span class=kn>import</span> <span class=n>ConnectionFailure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mongodb_uri</span> <span class=o>=</span> <span class=s2>&#34;mongodb://rootuser:rootpass@localhost:27017/mydatabase?authSource=admin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 嘗試連接 MongoDB</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>MongoClient</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 嘗試獲取服務器訊息，以確認連接</span>
</span></span><span class=line><span class=cl>        <span class=n>info</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>server_info</span><span class=p>()</span>  <span class=c1># 會在連接失敗時拋出 ConnectionFailure 異常</span>
</span></span><span class=line><span class=cl>        <span class=n>mongodb_version</span> <span class=o>=</span> <span class=n>info</span><span class=p>[</span><span class=s1>&#39;version&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MongoDB 連接成功。Mongo 版本為&#34;</span><span class=p>,</span> <span class=n>mongodb_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>client</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>ConnectionFailure</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;MongoDB 連接失敗。請檢查您的連接設置和Server狀態。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span></code></pre></div><p>這樣就代表我們成功連線到 MongoDB 了。</p><ol start=3><li>透過 Python 讀取 yaml 並寫入 MongoDB
接下來我想要將讀取的 domains.yaml 寫入 Ｍ ongo ，會用到之前的 <code>load_data_from_yaml</code>：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定義要操作的集合名稱</span>
</span></span><span class=line><span class=cl><span class=n>collection_name</span> <span class=o>=</span> <span class=s2>&#34;domains&#34;</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>yaml_file_path</span> <span class=o>=</span> <span class=s2>&#34;domains.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=n>domain_data</span> <span class=o>=</span> <span class=n>load_data_from_yaml</span><span class=p>(</span><span class=n>yaml_file_path</span><span class=p>,</span> <span class=s2>&#34;domain_envs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每次執行迴圈都會取得一個鍵值對，env 是 key，格式為 string，</span>
</span></span><span class=line><span class=cl><span class=c1># 而 value 則會是 domains，格式是 list</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>env</span><span class=p>,</span> <span class=n>domains</span> <span class=ow>in</span> <span class=n>domain_data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Writing domains for env </span><span class=si>{</span><span class=n>env</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>domains</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 這裡組成一個 document，方便儲存到 Mongo 裡</span>
</span></span><span class=line><span class=cl>    <span class=n>document</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>domains</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 更新條件，匹配那些 env 字段等於當前 env 值的 document</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 將匹配的 document 的內容設為 `document` 字典中的內容</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用 upsert=True，如果不存在則插入，存在則更新</span>
</span></span><span class=line><span class=cl>    <span class=n>collection</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;$set&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>},</span> <span class=n>upsert</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;資料已成功寫入 MongoDB。&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>在</span><span class=w> </span><span class=n>Mongo</span><span class=w> </span><span class=err>中，如果指定的集合</span><span class=w> </span><span class=p>(</span><span class=n>collection</span><span class=p>)</span><span class=w> </span><span class=err>不存在，當你進行第一次寫入操作（如插入文檔）時，</span><span class=n>MongoDB</span><span class=w> </span><span class=err>會自動創建這個集合。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>集合的創建是懶惰的（</span><span class=n>lazy</span><span class=err>），意味著直到你對集合進行了第一次寫入操作（例如使用</span><span class=w> </span><span class=o>`</span><span class=n>insert_one</span><span class=o>`</span><span class=err>、</span><span class=o>`</span><span class=n>insert_many</span><span class=o>`</span><span class=err>、</span><span class=o>`</span><span class=n>update_one</span><span class=o>`</span><span class=w> </span><span class=err>等方法），集合才會被實際創建。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>這種設計使得在</span><span class=w> </span><span class=n>MongoDB</span><span class=w> </span><span class=err>中處理集合非常靈活，你不需要事先創建集合就可以開始開發和測試你的應用程序。</span><span class=n>MongoDB</span><span class=w> </span><span class=err>會根據需要自動管理集合的創建。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>儲存要注意的地方是格式，這裡因為使用的是</span><span class=w> </span><span class=n>Mongo</span><span class=err>，所以我們這邊將讀取的格式組成一個</span><span class=w> </span><span class=n>document</span><span class=err>。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>在</span><span class=w> </span><span class=n>Mongo</span><span class=w> </span><span class=err>中，每個</span><span class=w> </span><span class=n>document</span><span class=w> </span><span class=err>都是以</span><span class=w> </span><span class=nf>BSON</span><span class=p>(</span><span class=k>Binary</span><span class=w> </span><span class=n>JSON</span><span class=p>)</span><span class=w> </span><span class=err>格式儲存，這是一種類似於</span><span class=w> </span><span class=n>JSON</span><span class=w> </span><span class=err>的格式。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>每個文檔都是由鍵值對（</span><span class=k>key</span><span class=o>-</span><span class=n>value</span><span class=w> </span><span class=n>pairs</span><span class=err>）組成的資料結構，其中每個鍵（</span><span class=k>key</span><span class=err>）是一個字符串，而值（</span><span class=n>value</span><span class=err>）可以是不同類型的資料類型，包括但不限於字符串、數字、布爾值、列表（在</span><span class=w> </span><span class=n>BSON</span><span class=w> </span><span class=err>中稱為）、甚至是嵌套的文檔。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>可參考官方文檔</span><span class=p>[</span><span class=err>官方文檔</span><span class=p>](</span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>www</span><span class=p>.</span><span class=n>mongodb</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>docs</span><span class=o>/</span><span class=n>manual</span><span class=o>/</span><span class=n>reference</span><span class=o>/</span><span class=n>bson</span><span class=o>-</span><span class=n>types</span><span class=o>/</span><span class=c1>#bson-types)。
</span></span></span></code></pre></div><p><code>update_one</code>基本語法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>collection</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span><span class=nb>filter</span><span class=p>,</span> <span class=n>update</span><span class=p>,</span> <span class=n>upsert</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></div><ul><li><code>filter</code>：一個字典，用於指定查詢條件，以匹配需要更新的文檔。</li><li><code>update</code>：一個字典，用於指定如何更新匹配的文檔。這通常涉及到 MongoDB 的更新操作符，如 <code>$set</code>、<code>$unset</code> 等。</li><li><code>upsert</code>：一個可選的 boolean 值，默認為 <code>False</code>。如果設置為 <code>True</code>，當沒有文檔匹配 <code>filter</code> 查詢條件時，<code>update</code> 操作將會作為一個新的 doc 被插入到集合中。</li></ul><p>寫入成功後可以透過 MongoShell 或是 Mongo Compass，這邊使用 MongoShell，在 docker-compose.yaml 添加 MongoShell 的 service：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mongoshell</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mongo:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>mongodb_mongoshell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;mongosh&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;--host&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;mongodb&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;--username&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;rootuser&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;--password&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;rootpass&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;--authenticationDatabase&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s2>&#34;admin&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stdin_open</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tty</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>接著透過以下指令進入 mongoshell：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker-compose run mongoshell
</span></span></code></pre></div><p>要查看 collection 需執行以下 query：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>use mydatabase
</span></span><span class=line><span class=cl>db.domains.find({})
</span></span></code></pre></div><p>這段代碼用意如下：</p><ul><li>選擇 mydatabase db</li><li>查詢 domains collection 中所有的 document</li></ul><p>輸出類似以下訊息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>_id:</span> <span class=err>ObjectId(&#39;66150a22e1a8ac17b898a2f0&#39;),</span>
</span></span><span class=line><span class=cl>    <span class=err>env:</span> <span class=err>&#39;live&#39;,</span>
</span></span><span class=line><span class=cl>    <span class=err>domains:</span> <span class=err>[</span> <span class=err>&#39;google.com&#39;,</span> <span class=err>&#39;en.wikipedia.org&#39;</span> <span class=err>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>讓我們稍微優化一下程式碼：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_domain_data_to_mongodb</span><span class=p>(</span><span class=n>mongo_client</span><span class=p>,</span> <span class=n>collection_name</span><span class=p>,</span> <span class=n>domain_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>mongo_client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>env</span><span class=p>,</span> <span class=n>domains</span> <span class=ow>in</span> <span class=n>domain_data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>document</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>domains</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># 更新條件，這裡假設 env 是唯一的</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 upsert=True，如果不存在則插入，存在則更新</span>
</span></span><span class=line><span class=cl>        <span class=n>collection</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;$set&#34;</span><span class=p>:</span> <span class=n>document</span><span class=p>},</span> <span class=n>upsert</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;數據已成功寫入 MongoDB。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>collection_name</span> <span class=o>=</span> <span class=s2>&#34;domains&#34;</span>
</span></span><span class=line><span class=cl><span class=n>yaml_file_path</span> <span class=o>=</span> <span class=s2>&#34;domains.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=n>domain_data</span> <span class=o>=</span> <span class=n>load_data_from_yaml</span><span class=p>(</span><span class=n>yaml_file_path</span><span class=p>,</span> <span class=s2>&#34;domain_envs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>write_domain_data_to_mongodb</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>collection_name</span><span class=p>,</span> <span class=n>domain_data</span><span class=p>)</span>
</span></span></code></pre></div><p>這樣就完成了從 yaml 進行寫入，接著需要撰寫另一套，透過傳入 env 以及 domain 資訊來進行寫入。</p><ol start=4><li>透過 Python 傳入 env 以及 domain 寫入 MongoDB
會需要這個功能是因為之後要透過 TG Bot 傳入 env 以及 domain 進行寫入的操作：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_domain_to_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>domain</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 嘗試添加或更新該 env 的域名</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>},</span> <span class=p>{</span><span class=s2>&#34;$addToSet&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>domain</span><span class=p>}},</span> <span class=n>upsert</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>matched_count</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>result</span><span class=o>.</span><span class=n>upserted_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;域名已成功添加或更新。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;域名添加或更新失敗。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>collection_name</span> <span class=o>=</span> <span class=s2>&#34;domains&#34;</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>add_env</span> <span class=o>=</span> <span class=s2>&#34;dev&#34;</span>
</span></span><span class=line><span class=cl><span class=n>add_domain</span> <span class=o>=</span> <span class=s2>&#34;test.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>add_domain_to_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>add_env</span><span class=p>,</span> <span class=n>add_domain</span><span class=p>)</span>
</span></span></code></pre></div><p>使用 <code>addToSet</code> 是為了確保新增時，如果已存在不會重複新增，確保每個 domain 的唯一性。</p><p>新增的部分告一段落，接著來進行讀取的部分。</p><ol start=5><li>透過 Python 讀取 MongoDB
讀取可以透過 <code>collection.find({})</code> 進行查詢：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>domain_envs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>find</span><span class=p>({})</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>env</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;env&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>domains</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;domains&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>env</span> <span class=ow>and</span> <span class=n>domains</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>domain_envs</span><span class=p>[</span><span class=n>env</span><span class=p>]</span> <span class=o>=</span> <span class=n>domains</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>domain_envs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;從 MongoDB 讀取數據失敗: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><p>接著優化一下代碼：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>load_domain_envs_from_mongodb</span><span class=p>(</span><span class=n>mongo_client</span><span class=p>,</span> <span class=n>collection_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>mongo_client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>domain_envs</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>find</span><span class=p>({})</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>env</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;env&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>domains</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;domains&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>env</span> <span class=ow>and</span> <span class=n>domains</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>domain_envs</span><span class=p>[</span><span class=n>env</span><span class=p>]</span> <span class=o>=</span> <span class=n>domains</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>domain_envs</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;從 MongoDB 讀取數據失敗: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><p>這樣就算是完成了基本的讀取，接下來要做取得單一 domain 資訊：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_domain_from_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env</span><span class=p>,</span> <span class=n>domain</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 構造查詢條件</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env</span><span class=p>,</span> <span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>domain</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># 執行查詢操作</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>find_one</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;get result&#34;</span><span class=p>,</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 找到了相應的文檔，返回域名訊息</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;在環境 &#39;</span><span class=si>{</span><span class=n>env</span><span class=si>}</span><span class=s2>&#39; 下找到域名 &#39;</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#39; 的訊息。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 沒有找到相應的文檔</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;在環境 &#39;</span><span class=si>{</span><span class=n>env</span><span class=si>}</span><span class=s2>&#39; 下未找到域名 &#39;</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#39; 的訊息。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>init_mongo_client</span><span class=p>(</span><span class=n>mongodb_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>collection_name</span> <span class=o>=</span> <span class=s2>&#34;domains&#34;</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>get_env</span> <span class=o>=</span> <span class=s2>&#34;live&#34;</span>
</span></span><span class=line><span class=cl><span class=n>get_domain</span> <span class=o>=</span> <span class=s2>&#34;google.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>get_domain_from_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>get_env</span><span class=p>,</span> <span class=n>get_domain</span><span class=p>)</span>
</span></span></code></pre></div><p>讀取的部分告一段落，接著來進行修改的部分。</p><ol start=6><li>透過 Python 修改 MongoDB
假設我們目前的 MongoDB 資料如下：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>_id:</span> <span class=err>ObjectId(&#39;66150a22e1a8ac17b898a2f0&#39;),</span>
</span></span><span class=line><span class=cl>    <span class=err>env:</span> <span class=err>&#39;live&#39;,</span>
</span></span><span class=line><span class=cl>    <span class=err>domains:</span> <span class=err>[</span> <span class=err>&#39;google.com&#39;,</span> <span class=err>&#39;en.wikipedia.org&#39;</span> <span class=err>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>我打算將 <code>google.com</code> 改成 <code>github.com</code>，只需要將原本用來新增的 <code>update_one</code> 裡的 <code>query</code> 多一個 <code>domains</code> 欄位：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_domain_in_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env_value</span><span class=p>,</span> <span class=n>old_domain</span><span class=p>,</span> <span class=n>new_domain</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 建立查詢條件和更新動作</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env_value</span><span class=p>,</span> <span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>old_domain</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>update_action</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;$set&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;domains.$&#34;</span><span class=p>:</span> <span class=n>new_domain</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 執行更新操作</span>
</span></span><span class=line><span class=cl>    <span class=n>update_result</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>update_many</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>update_action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>update_result</span><span class=o>.</span><span class=n>matched_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;成功更新文檔。匹配數量: </span><span class=si>{</span><span class=n>update_result</span><span class=o>.</span><span class=n>matched_count</span><span class=si>}</span><span class=s2>, 修改數量: </span><span class=si>{</span><span class=n>update_result</span><span class=o>.</span><span class=n>modified_count</span><span class=si>}</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;未找到匹配的文檔或域名，更新未執行。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>env_value</span> <span class=o>=</span> <span class=s2>&#34;live&#34;</span>
</span></span><span class=line><span class=cl><span class=n>origin_domain</span> <span class=o>=</span> <span class=s2>&#34;google.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>new_domain</span> <span class=o>=</span> <span class=s2>&#34;github.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>update_domain_in_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env_value</span><span class=p>,</span> <span class=n>origin_domain</span><span class=p>,</span> <span class=n>new_domain</span><span class=p>)</span>
</span></span></code></pre></div><p>這裡有用到 <code>$</code> 佔位符，主要是將查詢語句的第一個值來做 update，
會先查找 <code>env</code> 等於 <code>env_value</code> 並且 <code>domains</code> 等於 <code>old_domain</code>， 接著將 <code>domains</code> list 中第一個匹配的 <code>old_domain</code> 元素更新為 <code>new_domain</code>。</p><p>可參考官網的<a href=https://www.mongodb.com/zh-cn/docs/manual/reference/operator/query/>操作符文檔</a>。</p><ol start=7><li>透過 Python 刪除 MongoDB
最後一步要做的是刪除，能夠在指定的 <code>env</code> 刪除 <code>domain</code>：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_domain_in_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env_value</span><span class=p>,</span> <span class=n>domain_to_delete</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;env&#34;</span><span class=p>:</span> <span class=n>env_value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>delete_action</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;$pull&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;domains&#34;</span><span class=p>:</span> <span class=n>domain_to_delete</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=n>collection</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>delete_action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_default_database</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=p>[</span><span class=n>collection_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>env_value</span> <span class=o>=</span> <span class=s2>&#34;live&#34;</span>
</span></span><span class=line><span class=cl><span class=n>delete_domain</span> <span class=o>=</span> <span class=s2>&#34;github.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>delete_domain_in_mongodb</span><span class=p>(</span><span class=n>collection</span><span class=p>,</span> <span class=n>env_value</span><span class=p>,</span> <span class=n>delete_domain</span><span class=p>)</span>
</span></span></code></pre></div><p>刪除一樣用 <code>update</code> 方法，然後使用 <code>$pull</code> 操作符，刪除指定的項目，<a href=https://www.mongodb.com/zh-cn/docs/manual/reference/operator/update/pull/>官方文檔</a>在這。</p><p>MongoDB 操作的部分就先告一段落，下篇會教如何打造屬於自己的 Telegram Bot，讓我的機器人能夠接收指令。</p><p>如果想看完整程式碼可以參考這裡
🔗 專案 repo &ndash;> <a href=https://github.com/sz9751210/monitor/tree/main/monitor-ssl/ep1-mongo-setup>ep1-mongo-setup</a></p><h2 id=reference>📚Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://www.mongodb.com/zh-cn/docs/manual/>MongoDB 手册</a></li><li><a href=https://pymongo.readthedocs.io/en/stable/>PyMongo 4.6.3 documentation</a></li><li><a href=https://www.mongodb.com/docs/v4.4/mongo/>The mongo Shell — MongoDB Manual</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://sz9751210.github.io/tags/telegram/>telegram</a></li><li><a href=https://sz9751210.github.io/tags/ssl-monitor/>ssl-monitor</a></li><li><a href=https://sz9751210.github.io/tags/mongodb/>mongodb</a></li><li><a href=https://sz9751210.github.io/tags/python/>python</a></li></ul><div class=post-meta>更新於: 2024-05-14</div><nav class=paginav><a class=next href=https://sz9751210.github.io/posts/terraform-cloudflare/><span class=title>Next »</span><br><span>實現 CloudFlare DNS 解析：使用 Terraform 和 GCS 進行高效配置</span></a></nav><script src=https://utteranc.es/client.js repo=sz9751210/utterances issue-term=title theme=github-dark crossorigin=anonymous async></script><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on twitter" href="https://twitter.com/intent/tweet/?text=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f&amp;hashtags=telegram%2cssl-monitor%2cmongodb%2cpython"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f&amp;title=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info&amp;summary=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info&amp;source=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f&title=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on whatsapp" href="https://api.whatsapp.com/send?text=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info%20-%20https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Telegram 憑證監控機器人實作 EP1 - 讀取 MongoDB Domain Info on telegram" href="https://telegram.me/share/url?text=Telegram%20%e6%86%91%e8%ad%89%e7%9b%a3%e6%8e%a7%e6%a9%9f%e5%99%a8%e4%ba%ba%e5%af%a6%e4%bd%9c%20EP1%20-%20%e8%ae%80%e5%8f%96%20MongoDB%20Domain%20Info&amp;url=https%3a%2f%2fsz9751210.github.io%2fposts%2ftg-bot-ep1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://sz9751210.github.io/>艾倫的程式之旅</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let detail=document.getElementsByClassName("details");details=[].slice.call(detail);for(let e=0;e<details.length;e++){let t=details[e];const n=t.getElementsByClassName("details-summary")[0];n&&n.addEventListener("click",()=>{t.classList.toggle("open")},!1)}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>